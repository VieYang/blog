---
layout: post
title: "简单CDN整理"
comments: true
description: "CDN"
keywords: "CDN"
author: "Vie && Internet"
category: "CDN"
---

[CDN](/CDN)

# CDN概述

CDN是Content Delivery Network首字母缩写，译成中文就是内容分发网络。使用CDN技术的主要目的在于增加访问速度、解决南北互联（国内使用）、提高用户体验等。

> CDN历史上最有名的事件当属关于克林顿丑闻的斯塔尔报告被放在互联网,因下载该报告的人太多,最终导致服务器瘫痪。该事件直接促使CDN的诞生。

## Why use CDN

* 解决网站高流量、大并发的问题
* 解决南北互联问题（电信、网通~~~）
* 访问速度（缓存技术~~Varnish）
* 降低总体运营成本（视频方面尤为明显）
* 提高网站的可用性
* 抗DDOS攻击

## CDN使用的场合

静态对象加速明显：html页面文件、视频文件、JS文件、CSS文件、EXE文件、图片文件（JPEG、GIT、PNG）等

直播的视频是怎么处理的？？？

## CDN的组成

CDN是一种组合技术，包括源站、缓存服务器、智能DNS、客户端等几个部分。

* 源站是发布内容的原始网站。新增、删除和更改网站的文件，都是在源站上进行的；缓存服务器抓取的对象也全部来自于源站。
* 缓存服务器是直接提供给用户访问的站点资源，有一个或数个服务器组成；当一个用户发起访问时，他的访问请求被智能DNS定位到离他较近的缓存服务器。如果访问所需的内容没有被缓存，则缓存服务器向邻近的缓存服务器或直接向源站抓取内容，然后再返还给用户；如果用户所请求的内容刚好在缓存里面，则直接把内容返还给用户。
* 智能DNS是整个CDN的核心，它负责根据用户的来源，将其访问请求转向到离用户较近或较合适的缓存服务器，如把长沙电信的用户请求转向到长沙电信机房的缓存服务器。实现智能DNS的一种技术是：Bind View，在Bind 9以后的版本，都应该支持View 视图这个功能。另外还有一个方案，即DNS轮询方式。
* 客户端~~~浏览器

## 什么是简单CDN

简单CDN这个概念，是相对于复杂CDN来定义的。因此，我们先来了解一下什么是复杂的CDN。
笼统一点讲，CDN服务提供商所运营的环境，就是复杂CDN。就缓存服务器而言，其结构是分层次的，一般可划分为核心节点和边缘节点，并且同一层级的相邻节点之间又可形成姐妹关系，亦即在同一个集群下的节点互为姐妹关系。为了保证最高的性能和效率，不提倡跨网或跨物理范围的节点形成姐妹关系。为了更直观地理解这个结构和由此产生的好处，这里以一个最长访问路径的图示来说明，如图7-2所示。

![Minion](images/CDN-7-2.png)

图7-2  缓存服务器相互关系

说明如下：
1. 用户向某边缘服务器（边缘A）发起访问请求，所需内容没有被缓存。
2. 边缘服务器（边缘A）于是询问其邻居，是否缓存了用户所需的请求对象，邻居节点也没有缓存所需的对象。
3. 边缘服务器（边缘A）转而向某个父节点（核心A）请求文件，如果该父节点仍然无所需的文件，则该父节点询问其邻居；如果邻居也没有所需的文件，则把请求转给源站。
4. 源站返回数据给核心节点（核心A），并缓存数据在该节点。
5. 核心节点（核心A）返还数据给边缘节点（边缘A），并缓存数据在该节点。
6. 边缘节点返还数据给用户，一次最长路径的访问完成。

除了缓存服务器结构上的差异外，复杂CDN还具备以下一些特性。
* 缓存服务器布点范围广，服务器数量庞大
* 复杂的日志处理系统。因为计费依赖于访问日志
* 详细的视图划分。例如精确到每个省的IP地址段
* 预加载机制

所谓简单CDN，就是节点层次简单、服务器数量有限、能实现有限规模站点加速和发布的平台。通常情况下，我们不必为实现CDN带来的好处而部署复杂的CDN系统，这将花费巨大的人力、物力

# 简单CDN的设计

## 基本原则

* 选点合理，能覆盖大部分网络用户。最起码得在电信和网通机房放置缓存服务器，如果经费充裕，把教育网也考虑进来
* 系统本身具备很好的高可用特性。用户的访问主要集中在缓存服务器，缓存服务器之间使用集群技术就能得到比较高的系统可用性
* 算自建简单CDN的成本，使之有较好的性价比。如果自建一个CDN远比购买CDN服务商所花费的资金还高（目前国内商用CDN每兆带宽为50元/月，基数是1G），基本上没必要自己建立CDN了
* 系统应该具备很好的伸缩能力，以适应各种业务变化。如增加布点、增加设备、增加站点等

## 需求描述

欲对3个Web服务进行加速。为了描述方便，使用域名来进行说明。这3个加速站点为图片站点 images.sery.cn、下载站点dl.sery.cn、主站 www.sery.cn，3个站点全部是静态内容，其页面文件主要是.html（htm）、.exe、.css、.jpeg、.js等，非常适合被缓存。
服务的主要目标用户包括电信线路的用户、网通线路的用户、教育网的用户，其他线路的用户（如科技网、长城宽带等）访问请求被转向到网通线路的缓存服务器。为了实现这个目标，我们可能需要放置4组服务器来做缓存，即电信1组，网通2组，教育网1组。

## 简单CDN的设计

需求明确之后，接下来的设计工作包括：布点选取、工具选取、CDN结构设计等几部分。

### 布点选取

布点包括源站、全局智能DNS和缓存服务器集群
* 源站及全局智能DNS选择互联互通性较好的第三方BGH机房；因为使用CDN服务的站点数量有限，故在缓存服务器以主机名的方式寻址源站。
* 缓存服务器共4组，选择二线或三线城市的机房托管，能节省大量的资金（北京、上海等城市带宽价格大概在300 ~ 400元/兆/月，而偏远一点二三线城市（如安阳）1G带宽的年总费用才8 ~ 10万）

### 工具选取

工具包括操作系统、DNS软件、缓存服务器软件、负载均衡软件、源站软件以及定制的脚本。

* 所有的服务器均使用32位的CentOS 5.x。曾经使用过64位的系统，但在执行缓存服务器的缓存清理操作时，有些小问题
* DNS使用Bind-9.4.0。低于9.4.0的版本，可能不支持视图View，没有视图功能，智能DNS就无法实现。
* 缓存服务器有两种选择，一种是Squid，另一种是Varnish。Squid多用在复杂CDN场景，它能实现缓存服务器间的层级关系（邻居形成姊妹、边缘节点与核心节点形成父子关系），功能强大而配置复杂；Varnish为后起之秀，配置简单而性能卓越，维护起来也比较简单，因此本案选择Varnish作为缓存工具
* 负载均衡由Ipvsadm和Keepalived两部分组成。Ipvsadm是核心，负责包转发和负载分摊；Keepalived为框架，负责故障隔离和失败切换FailOver
* 可做Web服务的软件比较多，因为站点为简单的静态文件，选择Nginx比较省事。
* 定制脚本的主要目的是自动刷新缓存服务，把这个脚本放在某个服务器上，只需执行一次（也可使用Crontab自动调用）就能实现所有缓存服务器的缓存清理。

### CDN结构设计

![Minion](images/CDN-7-3.png)

图7-3  CDN服务器布局